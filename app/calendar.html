<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Monthly Calendar</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4caf50">

<style>
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: #121212;
  color: #fff;
  margin: 0;
  padding: 20px;
}
h1 { text-align:center; margin-bottom:20px; }
a { color:#4caf50; text-decoration:none; display:block; margin-bottom:10px; text-align:center; font-weight:bold; }
table { width:100%; border-collapse:collapse; table-layout:fixed; }
th { background:#2c2c2c; color:#ccc; padding:5px 0; font-weight:bold; }
td { border:1px solid #333; padding:3px; height:80px; vertical-align:top; overflow:hidden; font-size:12px; }
td div { max-height:60px; overflow-y:auto; }
.green { background:#4caf50; color:#000; padding:1px 3px; border-radius:3px; margin-bottom:2px; display:block; font-size:10px; }
.yellow { background:#ff9800; color:#000; padding:1px 3px; border-radius:3px; margin-bottom:2px; display:block; font-size:10px; }
.red { background:#f44336; color:#fff; padding:1px 3px; border-radius:3px; margin-bottom:2px; display:block; font-size:10px; }
</style>
</head>
<body>

<h1>Monthly Calendar</h1>
<a href="02.html">‚¨Ö Back to Tracker</a>
<a href="year.html">üìÖ View Year Calendar</a>
<table id="calendar"></table>

<script>
let tracks = JSON.parse(localStorage.getItem("tracks")) || [];

const today = new Date();
const year = today.getFullYear();
const month = today.getMonth();
const todayStr = year + '-' + String(month+1).padStart(2,'0') + '-' + String(today.getDate()).padStart(2,'0');

// --- Ensure today's history exists ---
tracks.forEach(t=>{
  if(!t.history) t.history={};
  if(t.history[todayStr] === undefined){
    t.history[todayStr] = t.type==="amount" ? t.value || 0 : t.done || false;
  }
});

function daysInMonth(m,y){ return new Date(y,m+1,0).getDate(); }

function buildCalendar(){
  const table = document.getElementById("calendar");
  table.innerHTML="";

  const headerRow = document.createElement("tr");
  ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].forEach(d=>{
    const th = document.createElement("th");
    th.innerText = d;
    headerRow.appendChild(th);
  });
  table.appendChild(headerRow);

  const firstDay = new Date(year,month,1).getDay();
  const totalDays = daysInMonth(month,year);
  let row = document.createElement("tr");
  let dayCounter = 1;

  for(let i=0;i<7;i++){
    if(i<firstDay) row.appendChild(document.createElement("td"));
    else {
      const cell = document.createElement("td");
      fillCell(cell,year,month,dayCounter);
      row.appendChild(cell);
      dayCounter++;
    }
  }
  table.appendChild(row);

  while(dayCounter<=totalDays){
    row=document.createElement("tr");
    for(let i=0;i<7;i++){
      if(dayCounter<=totalDays){
        const cell=document.createElement("td");
        fillCell(cell,year,month,dayCounter);
        row.appendChild(cell);
        dayCounter++;
      } else row.appendChild(document.createElement("td"));
    }
    table.appendChild(row);
  }
}

function fillCell(cell,y,m,d){
  const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
  const cellDate = new Date(y,m,d);

  if(cellDate > today) return;

  const link = document.createElement("a");
  link.href = `day.html?date=${dateStr}`;
  link.style.color="inherit";
  link.style.textDecoration="none";

  const strong = document.createElement("strong");
  strong.innerText = d;
  link.appendChild(strong);

  tracks.forEach(t=>{
    if(!t.history) t.history={};
    // Initialize missing date
    if(t.history[dateStr] === undefined){
      t.history[dateStr] = t.type==="amount" ? 0 : t.done || false;
    }

    const val = t.history[dateStr];
    const div = document.createElement("div");

    if(t.type==="amount"){
      if(val >= t.goal) div.className="green";
      else if(val>0) div.className="yellow";
      else div.className="red";
      div.innerText = `${t.name}: ${val}/${t.goal}`;
    } else {
      const done = !!val;
      div.className = done ? "green" : "red";
      div.innerText = `${t.name}: ${done ? "‚úÖ" : "‚ùå"}`;
    }

    link.appendChild(div);
  });

  cell.appendChild(link);
}

buildCalendar();
</script>
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/service-worker.js')
    .then(() => console.log('Service Worker Registered'));
}
</script>

</body>
</html>
